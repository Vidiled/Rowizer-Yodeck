<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
    <link href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.13.2/themes/smoothness/jquery-ui.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.13.2/jquery-ui.min.js"></script>
    <script src="js/clock.js" type="module"></script>
<!--    <script src='//unpkg.com/swagger-client' type='text/javascript'></script>-->

    <link href="styles.css" rel="stylesheet">
</head>

<body>

<style>

</style>
<!-- On-screen error banner (hidden by default) -->
<div id="widget-error" style="display:none;">
    <span id="widget-error-text"></span>
    <button id="widget-error-close" aria-label="Close">âœ•</button>
</div>
<div class="flex" id="wrapper">
    <div class="flex flex-fill">
        <div class="flex" id="title"></div>
        <div class="flex" id="clock">0:00:00</div>
    </div>
    <div style="display:none;" class="flex padding-standard content-background"  id="absences-container">
        Afwezig:<div class="flex"></div>

    </div>
    <div style="display:none;" class="flex padding-standard content-background"  id="outofoffice-container">
        <div>Activiteiten:</div><div id="outofoffice-inner-container"></div>

    </div>
    <div class="flex flex-fill" id="content-container">
    </div>
</div>
</body>
<script>
import {ZermeloApi} from "./zermelo/zermelo.js";
import {Changes} from "./controllers/changes/changes.js";
import Absences from "./controllers/absences/absences.js";
import {ZermeloAuthorizationError} from "./zermelo/utils/errors.js";
import ZermeloConnector from "./connectors/zermeloConnector.js";
import {ChangesUiManager} from "./views/changes/changesUiManager.js";
import AbsenceEntity from "./controllers/absences/absenceEntity.js";
import {AbsencesUiManager} from "./views/absences/absencesUiManager.js";
import OutOfOffice from "./controllers/outofoffice/outOfOffice.js";
import {OutOfOfficeUiManager} from "./views/outOfOffice/outOfOfficeUiManager.js";

var zapi = new ZermeloApi({
    portal: config.portal,
    token: config.token,
    branch: config.branch
});



function init_widget(config){
    console.log("loadedsdsdsd")

    let param_date = config.date;
    let param_branch = config.branch;
    let param_ignore = config.departmentsIgnore;
    let param_merge = config.mergeAppointments
    let param_external = config.external
    param_external = param_external ? param_external : "extern"


    let connector = new ZermeloConnector(zapi,param_date ? param_date : undefined, {branch: param_branch? param_branch : undefined, ignore_departments:param_ignore ? param_ignore.split(",") : []})
    AbsenceEntity.Connector = connector

    var changesManager = new Changes(connector, {
        merge_multiple_hour_span: !(param_merge && param_merge === "false")
    });
    var changesUiManager = new ChangesUiManager(document.querySelector("#content-container"), connector, changesManager)

    var absences = new Absences(connector)
    var absencesUiManager = new AbsencesUiManager(document.querySelector("#absences-container>div"),connector,absences);


    var outofoffice = new OutOfOffice(connector)
    var outOfOfficeUiManager = new OutOfOfficeUiManager(document.querySelector("#outofoffice-inner-container"),connector,outofoffice)

    window.cm = changesUiManager
    window.zc = connector

    let dayChanged = function(){
        changesManager.reset()
        changesUiManager.refreshTable()
        $("#title").text("Roosterwijzigingen " + connector.date.toLocaleString("nl-NL", {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        }))
    }
    window.dc = dayChanged

    connector.waitUntilReady().then(a=>{
        changesManager.loadData().then(cm => {
            changesUiManager.makeTable();
            changesUiManager.fillTable();
            var last_checked_date = new Date();
            setInterval(()=> {

                let new_date = new Date();
                if(last_checked_date.getDate() < new_date.getDate()){
                    //FIXME: now we do a hard reload
                    location.reload()
                    let diff = Math.round((new_date.getTime() - last_checked_date.getTime())/ (1000 * 3600 * 24));
                    let new_date_obk = new Date(connector.date)
                    new_date_obk.setDate(new_date_obk.getDate() + diff);
                    last_checked_date = new_date;
                    connector.setDate(new_date_obk).then(a=>{
                        changesManager.reset()
                        $("#title").text("Roosterwijzigingen " + connector.date.toLocaleString("nl-NL", {
                            weekday: 'long',
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        }))
                        absences.reset()

                    })

                }
                changesUiManager.refreshTable();

            }, 5*60*1000)
        })
        absencesUiManager.refresh().then(a=>{
            setInterval(()=>{
                absencesUiManager.refresh();
            }, 5*60*1000)
            document.querySelector("#absences-container").style.display = null
        }).catch(err=>{
            if(err instanceof ZermeloAuthorizationError){
                console.log("No authorization for absences")

            }
            else {
                throw err
            }
        });

        connector.waitUntilReady().then(a=> outofoffice.setExternalLocationName(param_external)).catch(err=>console.log(err))
            .then(a=> outofoffice.loadAll())
            .then(items=>{
                if(outofoffice.outOfOffices.length){
                    document.querySelector("#outofoffice-container").style.display = null
                }
                outOfOfficeUiManager.refresh()
                setInterval(()=>{
                    outOfOfficeUiManager.refresh();
                    if(outofoffice.outOfOffices.length){
                        document.querySelector("#outofoffice-container").style.display = null
                    }
                    else{
                        document.querySelector("#outofoffice-container").style.display = "none"
                    }
                }, 5*60*1000)
            })


    })


    $("#title").text("Roosterwijzigingen " + changesUiManager.date.toLocaleString("nl-NL", {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    }))


    /*$( window ).on( "resize", function() {
        console.log("resize")
        //also keep in mind the height of the resized window, scrollheigt-height is what we need to scroll

    } );*/


    // Your code to run since DOM is loaded and ready
};

</script>

</html>
